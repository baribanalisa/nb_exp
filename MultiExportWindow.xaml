<Window x:Class="NeuroBureau.Experiment.MultiExportWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:NeuroBureau.Experiment"
        Title="ÐœÑƒÐ»ÑŒÑ‚Ð¸ÑÐºÑÐ¿Ð¾Ñ€Ñ‚"
        Width="1100" Height="700"
        MinWidth="900" MinHeight="600"
        WindowStartupLocation="CenterOwner"
        Loaded="Window_Loaded"
        Style="{StaticResource ModernWindowStyle}">

    <Window.Resources>
        <local:StimulusDisplayNameConverter x:Key="StimulusDisplayNameConverter"/>
        
        <!-- ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚ÐµÑ€ Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ExportDataFormat -->
        <local:DataFormatConverter x:Key="DataFormatConverter"/>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="16"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Stimuli (Ñ Ð¼Ð¸Ð½Ð¸Ð°Ñ‚ÑŽÑ€Ð°Ð¼Ð¸) -->
        <Border Grid.Row="0" Grid.Column="0" Margin="0,0,0,12" Style="{StaticResource CardBorderStyle}">
            <DockPanel LastChildFill="True">
                <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="Ð¡Ñ‚Ð¸Ð¼ÑƒÐ»Ñ‹" Style="{StaticResource SectionTitleStyle}"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="Ð’ÑÐµ"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Click="SelectAllStimuli_Click"
                                Margin="0,0,8,0"/>
                        <Button Content="Ð¡Ð½ÑÑ‚ÑŒ Ð²ÑÐµ"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Click="ClearAllStimuli_Click"/>
                    </StackPanel>
                </Grid>

                <Border Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderColorBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="6">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding Stimuli}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Width="140" 
                                            CornerRadius="10" 
                                            Padding="8" 
                                            Margin="4"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="StimulusItem_Click">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="Transparent"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#F3F4F6"/>
                                                    </Trigger>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter Property="Background" Value="#E0E7FF"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        
                                        <StackPanel>
                                            <!-- ÐœÐ¸Ð½Ð¸Ð°Ñ‚ÑŽÑ€Ð° -->
                                            <Grid Height="80" Margin="0,0,0,8">
                                                <Border CornerRadius="8"
                                                        BorderBrush="{StaticResource BorderBrushSoft}"
                                                        BorderThickness="1"
                                                        Background="#F9FAFB"/>
                                                
                                                <Border CornerRadius="8" ClipToBounds="True">
                                                    <Image Source="{Binding Thumbnail}" 
                                                           Stretch="UniformToFill"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                                </Border>
                                                
                                                <!-- Ð˜ÐºÐ¾Ð½ÐºÐ° ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¿Ñ€ÐµÐ²ÑŒÑŽ -->
                                                <TextBlock Text="ðŸ–¼"
                                                           FontSize="24"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           Foreground="{StaticResource MutedTextBrush}"
                                                           Visibility="{Binding Thumbnail, Converter={StaticResource NullToVisibleConverter}}"/>
                                                
                                                <!-- Ð“Ð°Ð»Ð¾Ñ‡ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° -->
                                                <Border HorizontalAlignment="Right" 
                                                        VerticalAlignment="Top"
                                                        Margin="0,4,4,0"
                                                        Width="20" Height="20"
                                                        CornerRadius="10"
                                                        Background="#4F46E5"
                                                        Visibility="{Binding IsSelected, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <TextBlock Text="âœ“" 
                                                               Foreground="White" 
                                                               FontSize="12"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"/>
                                                </Border>
                                            </Grid>
                                            
                                            <!-- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ -->
                                            <TextBlock Text="{Binding DisplayName}"
                                                       FontSize="11"
                                                       TextTrimming="CharacterEllipsis"
                                                       TextAlignment="Center"
                                                       Foreground="{StaticResource TextBrush}"
                                                       ToolTip="{Binding Filename}"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </DockPanel>
        </Border>

        <!-- Results (Ñ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸, Ð´Ð°Ñ‚Ð°Ð¼Ð¸ Ð¸ Ð´Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒÑŽ) -->
        <Border Grid.Row="0" Grid.Column="2" Margin="0,0,0,12" Style="{StaticResource CardBorderStyle}">
            <DockPanel LastChildFill="True">
                <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Text="Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹" Style="{StaticResource SectionTitleStyle}"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="Ð’ÑÐµ"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Click="SelectAllResults_Click"
                                Margin="0,0,8,0"/>
                        <Button Content="Ð¡Ð½ÑÑ‚ÑŒ Ð²ÑÐµ"
                                Style="{StaticResource SecondaryButtonStyle}"
                                Click="ClearAllResults_Click"/>
                    </StackPanel>
                </Grid>

                <Border Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderColorBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="6">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                        <ItemsControl ItemsSource="{Binding Results}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border CornerRadius="10" 
                                            Padding="12,10" 
                                            Margin="2"
                                            Cursor="Hand"
                                            MouseLeftButtonDown="ResultItem_Click">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Background" Value="Transparent"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#F3F4F6"/>
                                                    </Trigger>
                                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                        <Setter Property="Background" Value="#E0E7FF"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- Checkbox -->
                                            <CheckBox Grid.Column="0" 
                                                      IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                      VerticalAlignment="Center"
                                                      Margin="0,0,10,0"/>
                                            
                                            <!-- Ð˜Ð¼Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ° -->
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding DisplayName}"
                                                           FontWeight="SemiBold"
                                                           FontSize="13"
                                                           Foreground="{StaticResource TextBrush}"
                                                           TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Uid}"
                                                           FontSize="10"
                                                           Foreground="{StaticResource MutedTextBrush}"
                                                           Visibility="{Binding Name, Converter={StaticResource StringNotEmptyToVisibilityConverter}}"/>
                                            </StackPanel>
                                            
                                            <!-- Ð”Ð°Ñ‚Ð° -->
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding DateText}"
                                                       FontSize="12"
                                                       Foreground="{StaticResource MutedTextBrush}"
                                                       VerticalAlignment="Center"
                                                       Margin="10,0"/>
                                            
                                            <!-- Ð”Ð»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ -->
                                            <Border Grid.Column="3"
                                                    Background="#F3F4F6"
                                                    CornerRadius="4"
                                                    Padding="8,4"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="{Binding DurationText}"
                                                           FontSize="11"
                                                           FontFamily="Consolas"
                                                           Foreground="{StaticResource TextBrush}"/>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Border>
            </DockPanel>
        </Border>

        <!-- Options panel -->
        <Border Grid.Row="1" Grid.ColumnSpan="3" Style="{StaticResource CardBorderStyle}" Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="140"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="ÐŸÐ°Ð¿ÐºÐ°" Style="{StaticResource FormLabelStyle}"/>
                <TextBox Grid.Column="1"
                         Text="{Binding OutputDir, UpdateSourceTrigger=PropertyChanged}"
                         MinWidth="520"/>
                <Button Grid.Column="2"
                        Content="â€¦"
                        Width="44"
                        Margin="10,0,0,0"
                        Style="{StaticResource SecondaryButtonStyle}"
                        Click="BrowseOutputDir_Click"/>

                <TextBlock Grid.Row="1" Text="Ð¨Ð°Ð±Ð»Ð¾Ð½" Style="{StaticResource FormLabelStyle}" Margin="0,10,0,0"/>
                <Grid Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Margin="0,10,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox Grid.Column="0"
                             Text="{Binding FilenameTemplate, UpdateSourceTrigger=PropertyChanged}"
                             MinWidth="520"/>

                    <TextBlock Grid.Column="1"
                               Text="{Binding TemplateStatusEmoji}"
                               FontSize="16"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"/>

                    <TextBlock Grid.Column="2"
                               Text="{Binding TemplateStatusText}"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"
                               Foreground="{StaticResource MutedTextBrush}"/>
                </Grid>

                <TextBlock Grid.Row="2" Text="Ð ÐµÐ¶Ð¸Ð¼" Style="{StaticResource FormLabelStyle}" Margin="0,10,0,0"/>
                <Border Grid.Row="2" Grid.Column="1" Margin="0,10,0,0"
                        Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderColorBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Width="260"
                        HorizontalAlignment="Left">
                    <ComboBox ItemsSource="{Binding Modes}"
                              SelectedItem="{Binding Mode}"
                              BorderThickness="0"
                              Background="Transparent"
                              Padding="10,8">
                        <ComboBox.Resources>
                            <Style TargetType="ComboBoxItem">
                                <Setter Property="Padding" Value="10,8"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F3F4F6"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#E5E7EB"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ComboBox.Resources>
                    </ComboBox>
                </Border>

                <!-- Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… -->
                <TextBlock Grid.Row="3" Text="Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…" Style="{StaticResource FormLabelStyle}" Margin="0,10,0,0"/>
                <Border Grid.Row="3" Grid.Column="1" Margin="0,10,0,0"
                        Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderColorBrush}"
                        BorderThickness="1"
                        CornerRadius="8"
                        Width="260"
                        HorizontalAlignment="Left">
                    <ComboBox ItemsSource="{Binding DataFormats}"
                              SelectedItem="{Binding DataFormat}"
                              BorderThickness="0"
                              Background="Transparent"
                              Padding="10,8">
                        <ComboBox.Resources>
                            <Style TargetType="ComboBoxItem">
                                <Setter Property="Padding" Value="10,8"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F3F4F6"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#E5E7EB"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ComboBox.Resources>
                    </ComboBox>
                </Border>

                <Grid Grid.Row="4" Grid.ColumnSpan="3" Margin="0,14,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <WrapPanel Grid.Column="0" VerticalAlignment="Center">
                        <CheckBox Content="Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (bin)" IsChecked="{Binding ExportSource}" IsEnabled="{Binding CanExportRawOrSource}" Margin="0,0,14,10"/>
                        <CheckBox Content="Ð¡Ñ‹Ñ€Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð²Ð·Ð³Ð»ÑÐ´Ð°" IsChecked="{Binding ExportRaw}" IsEnabled="{Binding CanExportRawOrSource}" Margin="0,0,14,10"/>
                        <CheckBox Content="Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ" IsChecked="{Binding ExportActions}" IsEnabled="{Binding CanExportRawOrSource}" Margin="0,0,14,10"/>
                        <CheckBox Content="ÐžÐ±Ð»Ð°ÑÑ‚Ð¸ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ°" IsChecked="{Binding ExportAoi}" Margin="0,0,14,10"/>
                        <CheckBox Content="ÐšÐ°Ñ€Ñ‚Ð° Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð²Ð·Ð³Ð»ÑÐ´Ð°" IsChecked="{Binding ExportGazeImage}" IsEnabled="{Binding CanExportImages}" Margin="0,0,14,10"/>
                        <CheckBox Content="Ð¢ÐµÐ¿Ð»Ð¾Ð²Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð°" IsChecked="{Binding ExportHeatImage}" IsEnabled="{Binding CanExportImages}" Margin="0,0,14,10"/>
                        <CheckBox Content="EDF" IsChecked="{Binding ExportEdf}" IsEnabled="{Binding CanExportEdf}" Margin="0,0,14,10"/>
                    </WrapPanel>

                    <Button Grid.Column="1"
                            Content="Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚"
                            Click="Export_Click"
                            Width="120"
                            Height="36"
                            Style="{StaticResource PrimaryButtonStyle}"
                            IsEnabled="{Binding CanStartExport}"/>
                </Grid>

                <TextBlock Grid.Row="5" Grid.ColumnSpan="3" Margin="0,10,0,0"
                           Foreground="{StaticResource TextBrush}"
                           Text="{Binding StatusText}"/>
            </Grid>
        </Border>
    </Grid>
</Window>
