<Window x:Class="NeuroBureau.Experiment.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        xmlns:local="clr-namespace:NeuroBureau.Experiment"
        Title="Neurobureau - Experiment"
        WindowStartupLocation="CenterScreen"
        WindowState="Maximized"
        KeyDown="Window_KeyDown"
        Loaded="Window_Loaded"
        FontFamily="Segoe UI"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True"
        TextOptions.TextFormattingMode="Display"
        TextOptions.TextRenderingMode="ClearType">

    <Window.Resources>

        <!-- ===== palette (адаптация твоих CSS-токенов под WPF) ===== -->
        <SolidColorBrush x:Key="BgBrush" Color="#FFF7F7F9"/>
        <SolidColorBrush x:Key="CardBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="CardHoverBrush" Color="#FFFBFBFD"/>
        <SolidColorBrush x:Key="TextBrush" Color="#FF111827"/>
        <SolidColorBrush x:Key="MutedTextBrush" Color="#FF6B7280"/>
        <SolidColorBrush x:Key="BorderBrushSoft" Color="#1A000000"/>

        <SolidColorBrush x:Key="AccentBrush" Color="#2563EB"/>

        <SolidColorBrush x:Key="BlueBrush" Color="#2563EB"/>
        <SolidColorBrush x:Key="GreenBrush" Color="#16A34A"/>
        <SolidColorBrush x:Key="GreenBgBrush" Color="#E8F7EE"/>

        <SolidColorBrush x:Key="BlueHoverBrush" Color="#1D4ED8"/>   
        <SolidColorBrush x:Key="BluePressedBrush" Color="#1E40AF"/>

        <SolidColorBrush x:Key="WarnBrush" Color="#F59E0B"/>
        <SolidColorBrush x:Key="WarnBgBrush" Color="#FFF7E6"/>

        <SolidColorBrush x:Key="DangerBrush" Color="#DC2626"/>
        <SolidColorBrush x:Key="DangerBgBrush" Color="#FEE2E2"/>


        <SolidColorBrush x:Key="ChipBgBrush" Color="#FFF3F3F5"/>
        <!-- ===== status colors ===== -->
        <SolidColorBrush x:Key="YellowBrush" Color="#F59E0B"/>
        <SolidColorBrush x:Key="RedBrush" Color="#DC2626"/>

        <SolidColorBrush x:Key="YellowBgBrush" Color="#FFFBEB"/>
        <SolidColorBrush x:Key="RedBgBrush" Color="#FEF2F2"/>
        <local:SplitDevicesConverter x:Key="SplitDevicesConverter"/>



        <!-- Цвета -->
        <SolidColorBrush x:Key="PillBorderBrush" Color="#E5E7EB"/>

        <SolidColorBrush x:Key="HoverBrush" Color="#F3F4F6"/>
        <SolidColorBrush x:Key="PressedBrush" Color="#E5E7EB"/>

        <!-- Нейтральная “пилюля” (как Настройки на скрине) -->
        <Style x:Key="TopBarPillButton" TargetType="Button">
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="FontSize" Value="14"/>

            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource PillBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>

            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource HoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource PressedBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>


        <!-- Синяя “пилюля” (как Запустить на скрине) -->
        <Style x:Key="TopBarPrimaryButton" TargetType="Button" BasedOn="{StaticResource TopBarPillButton}">
            <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="White"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="0.92"/>
                </Trigger>
                <Trigger Property="IsPressed" Value="True">
                    <Setter Property="Opacity" Value="0.85"/>
                </Trigger>
            </Style.Triggers>
        </Style>


        <Style x:Key="ExperimentDeviceChipStyle" TargetType="Border">
            <Setter Property="Background" Value="#FFEFF6FF"/>      <!-- light blue -->
            <Setter Property="BorderBrush" Value="#FFBFDBFE"/>     <!-- blue border -->
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="10,4"/>
            <Setter Property="Margin" Value="0,8,8,0"/>
        </Style>


        <!-- ===== common card style ===== -->
        <Style x:Key="CardBorderStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="14"/>
            <Setter Property="Padding" Value="18"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <!-- ===== top action buttons ===== -->
        <Style x:Key="TopActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource ChipBgBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="6,0,0,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFE9EBEF"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.45"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource BlueBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="14,9"/>
            <Setter Property="Margin" Value="6,0,0,0"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BlueHoverBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BlueHoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BluePressedBrush}"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BluePressedBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.45"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== tabs ===== -->
        <Style x:Key="TopTabControlStyle" TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
        </Style>

        <Style x:Key="TopTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
           
            <Setter Property="Padding" Value="18,12"/>
            
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Bd"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0,0,0,2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                TextElement.FontWeight="SemiBold"/>

                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== experiments list item (card) ===== -->
        <!-- ===== experiments list item (card) ===== -->
        <Style x:Key="ExperimentListItemStyle" TargetType="ListViewItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,14"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListViewItem">
                        <Grid SnapsToDevicePixels="True">
                            <!-- ТОЛЬКО тень (без текста внутри) -->
                            <Border x:Name="Shadow"
                                    CornerRadius="16"
                                    Background="{StaticResource CardBrush}">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="22" ShadowDepth="2" Opacity="0.10"/>
                                </Border.Effect>
                            </Border>

                            <!-- Карточка с текстом БЕЗ эффектов -->
                            <Border x:Name="Bd"
                                    Background="{StaticResource CardBrush}"
                                    BorderBrush="#1A000000"
                                    BorderThickness="1"
                                    CornerRadius="16"
                                    Padding="18"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter/>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource CardHoverBrush}"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="26" ShadowDepth="2" Opacity="0.14"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#FF93C5FD"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="28" ShadowDepth="2" Opacity="0.18"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>



        <!-- ===== chip ===== -->
        <Style x:Key="ChipStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource ChipBgBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="Margin" Value="0,0,8,0"/>
        </Style>

        <!-- ===== small device status card ===== -->
        <Style x:Key="DeviceMiniCardStyle" TargetType="Border" BasedOn="{StaticResource CardBorderStyle}">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="Margin" Value="0,0,12,0"/>
            <Setter Property="BorderBrush" Value="#33000000"/>
        </Style>
        <!-- ===== device status cards ===== -->
        <Style x:Key="DeviceCardStyle" TargetType="Border" BasedOn="{StaticResource CardBorderStyle}">
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="0,0,12,12"/>
            <Setter Property="BorderBrush" Value="#22000000"/>
        </Style>

        <Style x:Key="StatusPillStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="999"/>
            <Setter Property="Padding" Value="8,3"/>
            <Setter Property="Margin" Value="0,8,0,0"/>
        </Style>

        <Style x:Key="StatusIconStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- Зазор слева от вертикального скролла -->
        <Style TargetType="{x:Type ScrollBar}">
            <Setter Property="Margin" Value="0"/>
            <Style.Triggers>
                <Trigger Property="Orientation" Value="Vertical">
                    <Setter Property="Margin" Value="10,0,0,0"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ===== stimulus tile card ===== -->
        <Style x:Key="StimTileStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="Margin" Value="0,0,16,16"/>
        </Style>
        <Style x:Key="ResultsHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource MutedTextBrush}"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
        </Style>

        <Style x:Key="ResultsCellStyle" TargetType="DataGridCell">
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#1A2563EB"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ResultsRowStyle" TargetType="DataGridRow">
            <Setter Property="MinHeight" Value="34"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="Background" Value="White"/>
            <Style.Triggers>
                <Trigger Property="AlternationIndex" Value="1">
                    <Setter Property="Background" Value="#FFF9FAFB"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#1A2563EB"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <DataTemplate x:Key="DeviceCardTemplate">
            <Border Background="{Binding Bg}"
                    BorderBrush="{Binding Fg}"
                    BorderThickness="1"
                    CornerRadius="10"
                    Padding="10,6"
                    Margin="6">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Title}"
                            FontSize="14"
                            Foreground="#222"
                            VerticalAlignment="Center"/>

                    <!-- значок рядом с названием -->
                    <TextBlock Text="{Binding Emoji}"
                            Margin="8,0,0,0"
                            FontSize="14"
                            Foreground="{Binding Fg}"
                            VerticalAlignment="Center"/>
                </StackPanel>
            </Border>
        </DataTemplate>

    </Window.Resources>

    <Grid Background="{StaticResource BgBrush}">

        <!-- ===========================
             SELECT (как на макете)
             =========================== -->
        <Grid x:Name="SelectLayer" Background="{StaticResource BgBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Top header (лого + title + кнопки действий) -->
            <Border Grid.Row="0"
                    Background="{StaticResource CardBrush}"
                    BorderBrush="{StaticResource BorderBrushSoft}"
                    BorderThickness="0,0,0,1"
                    Padding="14,10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Border Width="28" Height="28" CornerRadius="14" Background="{StaticResource BlueBrush}">
                            <TextBlock Text="N" Foreground="White" FontWeight="SemiBold"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <TextBlock Text="Neurobureau - Experiment"
                                   Margin="10,0,0,0"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource TextBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                                        <!-- actions справа (вместо ToolBar, но с теми же именами/обработчиками) -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">

                        <!-- Мультиэкспорт -->
                        <Button Click="MultiExport_Click"
                                IsEnabled="{Binding HasSelection}"
                                Style="{StaticResource TopBarPillButton}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE74E;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Мультиэкспорт"/>
                            </StackPanel>
                        </Button>

                        <Button Click="Settings_Click"
                                Style="{StaticResource TopBarPillButton}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Настройки"/>
                            </StackPanel>
                        </Button>

                        <Button Click="Hardware_Click"
                                Style="{StaticResource TopBarPillButton}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE7F8;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Оборудование"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="BindBtn"
                                Click="BindSensors_Click"
                                IsEnabled="{Binding HasSelection}"
                                Style="{StaticResource TopBarPillButton}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE772;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Датчики"/>
                            </StackPanel>
                        </Button>

                        <Button x:Name="RunBtn"
                                Click="Run_Click"
                                IsEnabled="{Binding CanRun}"
                                Style="{StaticResource TopBarPrimaryButton}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE768;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Запустить" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>

                    </StackPanel>




                </Grid>
            </Border>

            <!-- Tabs + content -->
            <!-- Tabs + content: слева список всегда, справа вкладки -->
        <Grid Grid.Row="1" Background="{StaticResource BgBrush}">
              <Grid Margin="24,12,24,24">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="360"/>
                    <ColumnDefinition Width="24"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- ================= LEFT: Experiments (всегда видно) ================= -->
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>


                    <TextBlock Grid.Row="0"
                            Text="Experiments"
                            FontSize="22"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextBrush}"/>

                                        <TextBlock Grid.Row="1"
                            Text="Select an experiment to view details"
                            Margin="0,6,0,14"
                            Foreground="{StaticResource MutedTextBrush}"/>
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,14">

                        <!-- Добавить (это импорт .tar.gz) -->
                        <Button Click="Import_Click"
                                Style="{StaticResource TopActionButtonStyle}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="＋" Margin="0,0,8,0" FontSize="16"/>
                                <TextBlock Text="Добавить"/>
                            </StackPanel>
                        </Button>

                        <!-- Обновить -->
                        <Button Click="Refresh_Click"
                                Style="{StaticResource TopActionButtonStyle}"
                                Margin="0,0,10,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="⟳" Margin="0,0,8,0" FontSize="15"/>
                                <TextBlock Text="Обновить"/>
                            </StackPanel>
                        </Button>

                        <!-- Экспорт -->
                        <Button x:Name="ExportBtn"
                                Click="Export_Click"
                                IsEnabled="{Binding HasSelection}"
                                Style="{StaticResource TopActionButtonStyle}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="⇩" Margin="0,0,8,0" FontSize="15"/>
                                <TextBlock Text="Экспорт"/>
                            </StackPanel>
                        </Button>

                    </StackPanel>

                    <ListView Grid.Row="3"
                            x:Name="ExpList"

                            ItemsSource="{Binding Experiments}"
                            SelectedItem="{Binding SelectedExperiment, Mode=TwoWay}"
                            Background="Transparent"
                            BorderThickness="0"
                            ItemContainerStyle="{StaticResource ExperimentListItemStyle}"
                            MouseDoubleClick="ExpList_DoubleClick"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            ScrollViewer.CanContentScroll="True">

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <TextBlock Text="{Binding DisplayName}"
                                            FontWeight="SemiBold"
                                            Foreground="{StaticResource TextBrush}"
                                            TextWrapping="Wrap"
                                            TextTrimming="CharacterEllipsis"
                                            MaxHeight="44"/>

                                    <!-- устройства: нейтральные пилюли -->
                                    <ItemsControl Margin="0,6,0,0"
                                                ItemsSource="{Binding DevicesText, Converter={StaticResource SplitDevicesConverter}}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource ExperimentDeviceChipStyle}">
                                                    <TextBlock Text="{Binding}"
                                                            Foreground="#FF1D4ED8"
                                                            FontSize="12"/>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>


                    </ListView>
                </Grid>

                <!-- ================= RIGHT: вкладки (только 2) ================= -->
                <TabControl Grid.Column="2" Style="{StaticResource TopTabControlStyle}">
                    <TabControl.ItemContainerStyle>
                        <Style TargetType="TabItem" BasedOn="{StaticResource TopTabItemStyle}"/>
                    </TabControl.ItemContainerStyle>

                  

                    <!-- ===== Description: тут показываем то, что сейчас справа в Experiments (Devices + Stimuli) ===== -->
                    <TabItem Header="Stimuli">
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                    HorizontalScrollBarVisibility="Disabled">
                            <StackPanel>

                                <!-- Stimuli card -->
                                <Border Style="{StaticResource CardBorderStyle}"
                                        Background="Transparent"
                                        BorderBrush="Transparent"
                                        BorderThickness="0">
                                    <StackPanel>
                                        <DockPanel Margin="0,0,0,12" LastChildFill="True">
                                            <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                                                <TextBlock Text=""
                                                        FontFamily="Segoe MDL2 Assets"
                                                        Foreground="{StaticResource MutedTextBrush}"
                                                        Margin="0,1,8,0"/>
                                                <TextBlock Text="Stimuli"
                                                        FontSize="16"
                                                        FontWeight="SemiBold"
                                                        Foreground="{StaticResource TextBrush}"/>
                                            </StackPanel>

                                            <TextBlock DockPanel.Dock="Right"
                                                    Foreground="{StaticResource MutedTextBrush}"
                                                    FontSize="12"
                                                    VerticalAlignment="Center"
                                                    TextAlignment="Right"
                                                    Text="{Binding StimuliCountText}"/>
                                        </DockPanel>

                                        <ItemsControl ItemsSource="{Binding Stimuli}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>

                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Style="{StaticResource StimTileStyle}" Width="220">
                                                        <StackPanel>
                                                            <Grid Height="140">
                                                                <Border CornerRadius="10"
                                                                        BorderBrush="{StaticResource BorderBrushSoft}"
                                                                        BorderThickness="1"
                                                                        Background="{Binding PreviewBackground}"/>

                                                                <Border x:Name="ThumbClip" CornerRadius="10" ClipToBounds="True">
                                                                    <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                                                                </Border>

                                                                <TextBlock x:Name="VideoIcon"
                                                                        Text="▶"
                                                                        FontSize="36"
                                                                        Foreground="{StaticResource MutedTextBrush}"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Visibility="Collapsed"/>

                                                                <TextBlock x:Name="MissingIcon"
                                                                        Text="□"
                                                                        FontSize="28"
                                                                        Foreground="{StaticResource MutedTextBrush}"
                                                                        HorizontalAlignment="Center"
                                                                        VerticalAlignment="Center"
                                                                        Visibility="Collapsed"/>
                                                            </Grid>

                                                            <TextBlock Margin="0,10,0,0"
                                                                    FontSize="12"
                                                                    Foreground="{StaticResource MutedTextBrush}"
                                                                    Text="{Binding Title}"
                                                                    TextTrimming="CharacterEllipsis"/>
                                                        </StackPanel>
                                                    </Border>

                                                    <DataTemplate.Triggers>
                                                        <DataTrigger Binding="{Binding Thumbnail}" Value="{x:Null}">
                                                            <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>

                                                        <DataTrigger Binding="{Binding IsVideo}" Value="True">
                                                            <Setter TargetName="VideoIcon" Property="Visibility" Value="Visible"/>
                                                            <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>

                                                        <DataTrigger Binding="{Binding HasFile}" Value="False">
                                                            <Setter TargetName="MissingIcon" Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </DataTemplate.Triggers>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                    </StackPanel>
                                </Border>

                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>



                    <!-- ===== Results: тут будет таблица результатов (пока каркас) ===== -->
                    <TabItem Header="Results">
                        <Grid Background="{StaticResource BgBrush}" Margin="24">
                            <Border Style="{StaticResource CardBorderStyle}">
                                <DockPanel>
                                    <!-- шапка -->
                                    <!-- шапка -->
                                    <Grid DockPanel.Dock="Top" Margin="0,0,0,12">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock FontSize="16"
                                                FontWeight="SemiBold"
                                                Foreground="{StaticResource TextBrush}"
                                                Text="Results"
                                                VerticalAlignment="Center"/>

                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                            <Button Click="Results_Analyze_Click"
                                                    IsEnabled="{Binding HasSelection}"
                                                    Style="{StaticResource TopActionButtonStyle}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="📊" Margin="0,0,8,0" FontSize="14"/>
                                                    <TextBlock Text="Анализ…"/>
                                                </StackPanel>
                                            </Button>

                                            <Button Click="Results_SelectAll_Click"
                                                    IsEnabled="{Binding HasSelection}"
                                                    Style="{StaticResource TopActionButtonStyle}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="☑" Margin="0,0,8,0" FontSize="14"/>
                                                    <TextBlock Text="Выбрать все"/>
                                                </StackPanel>
                                            </Button>

                                            <Button Click="Results_Delete_Click"
                                                    IsEnabled="{Binding HasSelection}"
                                                    Style="{StaticResource TopActionButtonStyle}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="🗑" Margin="0,0,8,0" FontSize="14"/>
                                                    <TextBlock Text="Удалить"/>
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </Grid>


                                    <!-- таблица -->
                                    <DataGrid x:Name="ResultsGrid"
                                        ItemsSource="{Binding ResultsView}"
                                        AutoGenerateColumns="True"
                                        AutoGeneratingColumn="ResultsGrid_AutoGeneratingColumn"
                                        AlternationCount="2"
                                        FontWeight="Normal"
                                        FontSize="13"
                                        Foreground="{StaticResource TextBrush}"
                                        Background="Transparent"

                                        BorderThickness="0"
                                        GridLinesVisibility="None"
                                        HeadersVisibility="Column"
                                        RowHeaderWidth="0"

                                        CanUserAddRows="False"
                                        CanUserDeleteRows="False"
                                        CanUserResizeRows="False"

                                        SelectionUnit="FullRow"
                                        SelectionMode="Extended"

                                        EnableRowVirtualization="True"
                                        EnableColumnVirtualization="True"

                                        ColumnHeaderStyle="{StaticResource ResultsHeaderStyle}"
                                        CellStyle="{StaticResource ResultsCellStyle}"
                                        RowStyle="{StaticResource ResultsRowStyle}"
                                        />

                                </DockPanel>
                            </Border>
                        </Grid>
                    </TabItem>


                </TabControl>

                <!-- ===== чтобы не сломать code-behind, если он ещё обращается к этим x:Name ===== -->
                <Grid Grid.Column="2" Visibility="Collapsed">
                    <TextBlock x:Name="ExpNameText"/>
                    <TextBlock x:Name="ExpDescrText"/>
                    <TextBlock x:Name="ExpPathText"/>
                    <TextBlock x:Name="ExpMetaText"/>
                </Grid>

            </Grid>
        </Grid>

        </Grid>

        <!-- ===========================
             RUN LAYER (оставил твою часть как была)
             =========================== -->
        <Grid x:Name="RunLayer" Background="Black" Visibility="Collapsed">
            <Image x:Name="StimImage" Stretch="Uniform" Visibility="Collapsed"/>
            <MediaElement x:Name="StimVideo"
                          Visibility="Collapsed"
                          LoadedBehavior="Manual"
                          UnloadedBehavior="Manual"
                          Stretch="Uniform"
                          Volume="0" />
            <vlc:VideoView x:Name="StimVlc"
                           Visibility="Collapsed"
                           HorizontalAlignment="Stretch"
                           VerticalAlignment="Stretch" />

            <TextBlock x:Name="OverlayText"
                       Foreground="White"
                       FontSize="48"
                       TextAlignment="Center"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Visibility="Visible"/>
        </Grid>

    </Grid>
</Window>
