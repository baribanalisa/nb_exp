<Window x:Class="NeuroBureau.Experiment.AnalysisWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        xmlns:local="clr-namespace:NeuroBureau.Experiment"
        xmlns:controls="clr-namespace:NeuroBureau.Experiment.Controls"

        Title="Анализ"
        Width="1800" Height="840"
        WindowStartupLocation="CenterOwner"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        PreviewKeyDown="AnalysisWindow_PreviewKeyDown"
        Closing="Window_Closing"
        Closed="Window_Closed">

    <Window.Resources>
        <!-- Цвета -->
        <SolidColorBrush x:Key="BgBrush" Color="#FFF7F7F9"/>
        <SolidColorBrush x:Key="CardBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="CardHoverBrush" Color="#FFFBFBFD"/>
        <SolidColorBrush x:Key="TextBrush" Color="#FF111827"/>
        <SolidColorBrush x:Key="MutedTextBrush" Color="#FF6B7280"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#2563EB"/>
        <SolidColorBrush x:Key="BorderBrushSoft" Color="#1A000000"/>

        <!-- Мини-стиль "пилюля" -->
        <Style x:Key="PillButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#FF111827"/>
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFF3F4F6"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFE5E7EB"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль вкладок как в главном окне ===== -->
        <Style x:Key="TopTabControlStyle" TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
        </Style>

        <Style x:Key="TopTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="18,12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Bd"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0,0,0,2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                TextElement.FontWeight="SemiBold"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль кнопки тулбара визуализаций ===== -->
        <Style x:Key="ToolbarRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#6B7280"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Width="{TemplateBinding Width}"
                                Height="{TemplateBinding Height}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#E5E7EB"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#2563EB"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль списка как карточки экспериментов ===== -->
        <Style x:Key="StimulusListItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,14"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Grid SnapsToDevicePixels="True">
                            <!-- ТОЛЬКО тень (без текста внутри) -->
                            <Border x:Name="Shadow"
                                    CornerRadius="16"
                                    Background="{StaticResource CardBrush}">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="22" ShadowDepth="2" Opacity="0.10"/>
                                </Border.Effect>
                            </Border>

                            <!-- Карточка с текстом БЕЗ эффектов -->
                            <Border x:Name="Bd"
                                    Background="{StaticResource CardBrush}"
                                    BorderBrush="#1A000000"
                                    BorderThickness="1"
                                    CornerRadius="16"
                                    Padding="18"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter/>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource CardHoverBrush}"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="26" ShadowDepth="2" Opacity="0.14"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#FF93C5FD"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="28" ShadowDepth="2" Opacity="0.18"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="18">
    <Grid.ColumnDefinitions>
        <!-- Левый блок: стимул + низ (stimuli/results) -->
        <ColumnDefinition Width="*" MinWidth="700"/>
        <ColumnDefinition Width="6"/>
        <!-- Правая панель: таймлайн + графики -->
        <ColumnDefinition Width="420" MinWidth="320"/>
    </Grid.ColumnDefinitions>

    <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- ROW 0: Название эксперимента -->
    <TextBlock x:Name="ExperimentNameText"
               Grid.Column="0" Grid.Row="0"
               Grid.ColumnSpan="3"
               FontSize="18"
               FontWeight="SemiBold"
               Foreground="#111827"
               Margin="0,0,0,12"
               Text="Эксперимент"/>

    <!-- LEFT AREA (Column 0): Stimulus сверху + нижняя панель Stimuli/Results -->
    <Grid Grid.Column="0" Grid.Row="1">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="6"/>
            <RowDefinition Height="320" MinHeight="220"/>
        </Grid.RowDefinitions>

        <!-- TOP: Stimulus view -->
        <Border Grid.Row="0"
                CornerRadius="14"
                BorderThickness="0"
                BorderBrush="Transparent"
                Background="White"
                Padding="14">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- TOOLBAR (слева, как в фотошопе) -->
                <Border Grid.Column="0"
                        Background="#F3F4F6"
                        CornerRadius="8"
                        Padding="4"
                        Margin="0,0,12,0"
                        VerticalAlignment="Top">
                    <StackPanel Orientation="Vertical">
                        <!-- Кнопки настроек и экспорта -->
                        <Button x:Name="AnalysisSettingsBtn"
                                Width="40" Height="40"
                                Margin="2"
                                Background="Transparent"
                                BorderThickness="0"
                                Click="AnalysisSettingsBtn_Click"
                                Cursor="Hand"
                                ToolTip="Настройки анализа">
                            <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#6B7280"/>
                        </Button>

                        <Button x:Name="ExportMenuBtn"
                                Width="40" Height="40"
                                Margin="2"
                                Background="Transparent"
                                BorderThickness="0"
                                Click="ExportMenuBtn_Click"
                                Cursor="Hand"
                                ToolTip="Экспорт">
                            <Button.ContextMenu>
                                <ContextMenu x:Name="ExportContextMenu">
                                    <MenuItem Header="Экспорт визуализации" Click="ExportVisualization_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE8B9;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Экспорт областей интереса" Click="ExportAoiCsv_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE8A5;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Экспорт статистики" Click="ExportStatistics_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE9D9;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem x:Name="ExportKgrMenuItem" Header="Экспорт данных КГР" Click="ExportKgr_Click" Visibility="Collapsed">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE95A;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Button.ContextMenu>
                            <TextBlock Text="&#xE74E;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#6B7280"/>
                        </Button>

                        <Separator Margin="4,8" Background="#E5E7EB"/>

                        <!-- Визуализации -->
                        <RadioButton x:Name="ToolEyeMovement"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     IsChecked="True"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Карта движения взгляда"
                                     Tag="0"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE7B3;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolHeatmap"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Тепловая карта"
                                     Tag="1"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE9D9;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolBeeSwarm"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Пчелиный рой"
                                     Tag="2"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xECAD;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolAoi"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Области интереса"
                                     Tag="3"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE7C5;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>

                        <Separator Margin="4,8" Background="#E5E7EB"/>

                        <!-- Инструменты AOI (видны только в режиме AOI) -->
                        <StackPanel x:Name="AoiToolsPanel" Visibility="Collapsed">
                            <RadioButton x:Name="AoiToolRect"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         IsChecked="True"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Прямоугольник"
                                         Tag="Rectangle"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xE739;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>
                            <RadioButton x:Name="AoiToolEllipse"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Эллипс"
                                         Tag="Ellipse"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xEA3A;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>
                            <RadioButton x:Name="AoiToolPolygon"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Полигон"
                                         Tag="Polygon"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xE7C8;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>

                            <Separator Margin="4,8" Background="#E5E7EB"/>

                            <!-- Цвет AOI -->
                            <Button x:Name="AoiColorBtn"
                                    Width="36" Height="36"
                                    Margin="2"
                                    BorderThickness="2" BorderBrush="#CCC"
                                    Click="AoiColorBtn_Click"
                                    Cursor="Hand"
                                    ToolTip="Цвет области">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border CornerRadius="4" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="2"/>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- CONTENT (стимул) -->
                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Заголовок как на макете -->
                    <Border Grid.Row="0"
                            Background="Transparent"
                            BorderBrush="#E5E7EB"
                            BorderThickness="0,0,0,1"
                            Padding="8,2"
                            Margin="0,0,0,10">
                        
                    </Border>

                    <!-- Стимул + оверлеи -->
                    <Viewbox x:Name="StimulusViewbox" Grid.Row="1" Stretch="Uniform" HorizontalAlignment="Center">
                        <Canvas x:Name="ScreenCanvas"
                                Background="Black"
                                ClipToBounds="True">

                            <!-- color stimulus -->
                            <Border x:Name="ColorPreview"
                                    CornerRadius="12"
                                    Background="Transparent"
                                    Visibility="Collapsed"/>

                            <!-- image stimulus -->
                            <Image x:Name="PreviewImage"
                                   Visibility="Collapsed"
                                   Stretch="Fill"/>

                            <!-- video stimulus -->
                            <vlc:VideoView x:Name="PreviewVlc"
                                           Visibility="Collapsed">
                                <Grid>
                                    <local:FixationOverlay x:Name="VideoFixOverlay"
                                                          Visibility="Collapsed"
                                                          IsHitTestVisible="False"
                                                          HorizontalAlignment="Stretch"
                                                          VerticalAlignment="Stretch"/>
                                    <local:HeatmapOverlay x:Name="VideoHeatmapOverlay"
                                                         Visibility="Collapsed"
                                                         IsHitTestVisible="False"
                                                         HorizontalAlignment="Stretch"
                                                         VerticalAlignment="Stretch"/>

                                    <local:BeeSwarmOverlay x:Name="VideoBeeOverlay"
                                                          Visibility="Collapsed"
                                                          IsHitTestVisible="False"
                                                          HorizontalAlignment="Stretch"
                                                          VerticalAlignment="Stretch"/>
                                </Grid>
                            </vlc:VideoView>

                            <!-- overlay фиксаций (для картинок/цвета) -->
                            <local:FixationOverlay x:Name="FixOverlay"
                                                   Visibility="Collapsed"
                                                   IsHitTestVisible="False"/>

                            <!-- heatmap overlay (для картинок/цвета) -->
                            <local:HeatmapOverlay x:Name="HeatmapOverlay"
                                                  Visibility="Collapsed"
                                                  IsHitTestVisible="False"/>

                            <!-- beeswarm overlay (для картинок) -->
                            <local:BeeSwarmOverlay x:Name="BeeOverlay"
                                                   Visibility="Collapsed"
                                                   IsHitTestVisible="False"/>

                            <!-- AOI overlay -->
                            <local:AoiOverlay x:Name="AoiOverlay"
                                              Visibility="Collapsed"
                                              IsHitTestVisible="True"
                                              Width="{Binding ActualWidth, ElementName=ScreenCanvas}"
                                              Height="{Binding ActualHeight, ElementName=ScreenCanvas}"
                                              MouseLeftButtonDown="AoiOverlay_MouseDown"
                                              MouseMove="AoiOverlay_MouseMove"
                                              MouseLeftButtonUp="AoiOverlay_MouseUp"/>

                            <TextBlock x:Name="EmptyHint"
                                       Text="Выбери стимул"
                                       Foreground="#88000000"
                                       FontSize="16"
                                       TextAlignment="Center"/>
                        </Canvas>
                    </Viewbox>
                </Grid>
            </Grid>
        </Border>

        <!-- Splitter: регулируем высоту нижнего блока (только слева) -->
        <GridSplitter Grid.Row="1"
                      Height="6"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Center"
                      Background="Transparent"
                      Cursor="SizeNS"
                      ResizeBehavior="PreviousAndNext"/>

        <!-- BOTTOM (только под стимулом, не под графиками справа) -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" MinWidth="380"/>
                <ColumnDefinition Width="6"/>
                <ColumnDefinition Width="3*" MinWidth="520"/>
            </Grid.ColumnDefinitions>

            <!-- Stimuli -->
            <Border Grid.Column="0"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14">
                <DockPanel LastChildFill="True">
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <TextBlock Text="STIMULI"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="{StaticResource TextBrush}"
                                   HorizontalAlignment="Center"/>
                        <TextBlock x:Name="ResultInfoText"
                                   Visibility="Collapsed"
                                   Margin="0,4,0,0"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <!-- Сделано ближе к макету: плиткой (wrap) -->
                    <ListBox x:Name="StimuliList"
                             SelectionChanged="StimuliList_SelectionChanged"
                             BorderThickness="0"
                             Background="Transparent"
                             ScrollViewer.CanContentScroll="False"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ItemContainerStyle="{StaticResource StimulusListItemStyle}">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" ItemWidth="320" ItemHeight="240"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>

                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel>
                                    <Grid Height="140" Margin="0,0,0,10">
                                        <Border CornerRadius="10"
                                                BorderBrush="{StaticResource BorderBrushSoft}"
                                                BorderThickness="1"
                                                Background="{Binding PreviewBackground}"/>

                                        <Border x:Name="ThumbClip" CornerRadius="10" ClipToBounds="True">
                                            <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                                        </Border>

                                        <TextBlock x:Name="VideoIcon"
                                                   Text="▶"
                                                   FontSize="36"
                                                   Foreground="{StaticResource MutedTextBrush}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   Visibility="Collapsed"/>

                                        <TextBlock x:Name="MissingIcon"
                                                   Text="□"
                                                   FontSize="28"
                                                   Foreground="{StaticResource MutedTextBrush}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"
                                                   Visibility="Collapsed"/>
                                    </Grid>

                                    <TextBlock Text="{Binding Title}"
                                               FontWeight="SemiBold"
                                               FontSize="12"
                                               TextWrapping="Wrap"
                                               TextTrimming="CharacterEllipsis"
                                               MaxHeight="36"/>
                                    <TextBlock Text="{Binding Subtitle}"
                                               Margin="0,4,0,0"
                                               Foreground="{StaticResource MutedTextBrush}"
                                               FontSize="11"
                                               TextWrapping="Wrap"/>
                                </StackPanel>

                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding Thumbnail}" Value="{x:Null}">
                                        <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>

                                    <DataTrigger Binding="{Binding IsVideo}" Value="True">
                                        <Setter TargetName="VideoIcon" Property="Visibility" Value="Visible"/>
                                        <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                    </DataTrigger>

                                    <DataTrigger Binding="{Binding HasFile}" Value="False">
                                        <Setter TargetName="MissingIcon" Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <!-- Splitter между STIMULI и RESULTS -->
            <GridSplitter Grid.Column="1"
                          Width="6"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          Background="Transparent"
                          Cursor="SizeWE"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- Results -->
            <Border Grid.Column="2"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Top"
                               Text="RESULTS"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource TextBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,10"/>

                    <DataGrid x:Name="ResultsDataGrid"
                              PreviewMouseLeftButtonDown="ResultsDataGrid_PreviewMouseLeftButtonDown"
                              AutoGenerateColumns="False"
                              BorderThickness="0"
                              Background="Transparent"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              SelectionUnit="FullRow"
                              SelectionMode="Extended"
                              EnableRowVirtualization="True"
                              FontSize="12">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Width="32">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Center"
                                                  Focusable="False" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Цвет" Width="50">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Width="20" Height="20"
                                                CornerRadius="4"
                                                BorderThickness="1"
                                                BorderBrush="LightGray"
                                                Background="{Binding ColorBrush}"
                                                Cursor="Hand"
                                                MouseLeftButtonDown="ResultColorSwatch_MouseLeftButtonDown"
                                                Focusable="False"
                                                HorizontalAlignment="Center"
                                                ToolTip="{Binding ColorHex}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Дата" Width="110" Binding="{Binding DateString}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Длит., с" Width="70" Binding="{Binding DurationSec}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Имя" Width="*" Binding="{Binding Name}" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>
    </Grid>

    <!-- Splitter между левым блоком и правой панелью -->
    <GridSplitter Grid.Column="1" Grid.Row="1"
                  Width="6"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch"
                  Background="Transparent"
                  Cursor="SizeWE"/>

    <!-- RIGHT PANEL: Timeline над графиками, графики до низа -->
    <Border Grid.Column="2" Grid.Row="1"
            CornerRadius="14"
            BorderThickness="0"
            BorderBrush="Transparent"
            Background="White"
            Padding="14">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="12"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Timeline -->
            <Border Grid.Row="0"
                    Background="Transparent"
                    BorderBrush="#E5E7EB"
                    BorderThickness="0,0,0,1"
                    Padding="0,0,0,10">
                <StackPanel>
                    <TextBlock Text="Timeline"
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource TextBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,10"/>

                    <!-- video timeline (для видео-стимула) -->
                    <Grid x:Name="VideoTimelinePanel">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Button x:Name="PlayPauseBtn"
                                Grid.Column="0"
                                Style="{StaticResource PillButtonStyle}"
                                Width="80"
                                Padding="14,0"
                                Click="PlayPauseBtn_Click"
                                IsEnabled="False">
                            ▶ Play
                        </Button>

                        <Slider x:Name="TimeSlider"
                                Grid.Column="2"
                                Minimum="0"
                                Maximum="1"
                                Value="0"
                                IsEnabled="False"
                                PreviewMouseDown="TimeSlider_PreviewMouseDown"
                                PreviewMouseUp="TimeSlider_PreviewMouseUp"/>

                        <TextBlock x:Name="TimeText"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="00:00 / 00:00"/>
                    </Grid>

                    <!-- time slice (для картинок/цвета) -->
                    <Grid x:Name="SliceTimelinePanel"
                          Margin="0,10,0,0"
                          Visibility="Collapsed">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <Button x:Name="SlicePlayPauseBtn"
                                    Style="{StaticResource PillButtonStyle}"
                                    Width="40"
                                    Padding="0"
                                    Click="SlicePlayPauseBtn_Click"
                                    IsEnabled="False">
                                <TextBlock x:Name="SlicePlayPauseIcon"
                                           Text="▶"
                                           FontSize="14"/>
                            </Button>
                            <Button x:Name="SliceStopBtn"
                                    Style="{StaticResource PillButtonStyle}"
                                    Width="40"
                                    Padding="0"
                                    Margin="6,0,0,0"
                                    Click="SliceStopBtn_Click"
                                    IsEnabled="False">
                                <TextBlock Text="■" FontSize="12"/>
                            </Button>
                        </StackPanel>

                        <Grid Grid.Column="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="От"/>
                                <controls:TimeRangeSlider x:Name="SliceRange"
                                                         Grid.Column="2"
                                                         Minimum="0"
                                                         Maximum="1"
                                                         StartValue="0"
                                                         EndValue="1"
                                                         RangeChanged="SliceRange_RangeChanged"/>
                            </Grid>

                            <Grid Grid.Row="1" Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="Время"/>
                                <Slider x:Name="SliceTimeSlider"
                                        Grid.Column="2"
                                        Minimum="0"
                                        Maximum="1"
                                        Value="0"
                                        IsEnabled="False"
                                        ValueChanged="SliceTimeSlider_ValueChanged"/>
                            </Grid>
                        </Grid>

                        <TextBlock x:Name="SliceText"
                                   Grid.Row="0"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="—"/>

                        <TextBlock x:Name="SliceTimeText"
                                   Grid.Row="1"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="—"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Graphs -->
            <ScrollViewer Grid.Row="2"
                          VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <StackPanel>

                    <!-- Основной график / таблица AOI (карточка) -->
                    <Border CornerRadius="10"
                            BorderThickness="1"
                            BorderBrush="#E5E7EB"
                            Background="#FFFFFF"
                            Padding="10"
                            Margin="0,0,0,12">
                        <DockPanel LastChildFill="True">
                            <TextBlock DockPanel.Dock="Top"
                                       Text="Graph"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource TextBrush}"
                                       Margin="0,0,0,8"/>
                            <Grid Height="180">
                                <controls:MetricChart x:Name="MetricChart"/>

                                <DataGrid x:Name="AoiResultsGrid"
                                          Visibility="Collapsed"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          HeadersVisibility="Column"
                                          GridLinesVisibility="Horizontal"
                                          Background="White"
                                          BorderThickness="1"
                                          BorderBrush="#E5E7EB"
                                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                                          PreviewKeyDown="AoiResultsGrid_PreviewKeyDown">
                                    <DataGrid.Columns>
                                        <DataGridTemplateColumn Header="Цвет" Width="40">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Border Width="16" Height="16" CornerRadius="8" Background="{Binding ColorHex}" HorizontalAlignment="Center"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTextColumn Header="Название" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="120"/>
                                        <DataGridTextColumn Header="Фиксаций (N)" Binding="{Binding FixationCount}" IsReadOnly="True" Width="90"/>
                                        <DataGridTextColumn Header="Общее время (с)" Binding="{Binding TotalDwellTime, StringFormat=F2}" IsReadOnly="True" Width="110"/>

                                        <DataGridTextColumn Header="До первой (N)" Binding="{Binding FixationsBeforeFirst}" IsReadOnly="True" Width="90"/>
                                        <DataGridTextColumn Header="До первой фиксации (с)" Binding="{Binding TimeToFirstFixation, StringFormat=F2}" IsReadOnly="True" Width="130"/>
                                        <DataGridTextColumn Header="Длит. первой (с)" Binding="{Binding FirstFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="110"/>

                                        <DataGridTextColumn Header="Возвраты (N)" Binding="{Binding RevisitCount}" IsReadOnly="True" Width="90"/>
                                        <DataGridTextColumn Header="Ср. длит. фикс. (с)" Binding="{Binding AvgFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="120"/>

                                        <DataGridTextColumn Header="Саккад (N)" Binding="{Binding SaccadeCount}" IsReadOnly="True" Width="80"/>
                                        <DataGridTextColumn Header="Ср. ампл. саккад (°)" Binding="{Binding AvgSaccadeAmplitudeDeg, StringFormat=F2}" IsReadOnly="True" Width="130"/>

                                        <DataGridTextColumn Header="Путь (°)" Binding="{Binding ScanpathLengthDeg, StringFormat=F2}" IsReadOnly="True" Width="80"/>
                                        <DataGridTextColumn Header="Площадь (%)" Binding="{Binding AreaRatio, StringFormat=F1}" IsReadOnly="True" Width="90"/>

                                        <DataGridTemplateColumn Width="40">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="✕"
                                                            Click="DeleteAoiRow_Click"
                                                            Background="Transparent"
                                                            BorderThickness="0"
                                                            Foreground="Red"
                                                            Cursor="Hand"
                                                            ToolTip="Удалить область интереса"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Grid>
                        </DockPanel>
                    </Border>

                    <!-- КГР графики (вертикально, карточками) -->
                    <Border x:Name="KgrChartsPanel"
                            CornerRadius="10"
                            BorderThickness="1"
                            BorderBrush="#E5E7EB"
                            Background="#FFFFFF"
                            Padding="10"
                            Margin="0,0,0,12"
                            Visibility="Collapsed">
                        <StackPanel>
                            <TextBlock Text="KGR"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{StaticResource TextBrush}"
                                       Margin="0,0,0,8"/>

                            <Border CornerRadius="8"
                                    BorderThickness="1"
                                    BorderBrush="#E5E7EB"
                                    Background="#F9FAFB"
                                    Padding="8"
                                    Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBlock DockPanel.Dock="Top" Text="SR" FontSize="12" Foreground="{StaticResource MutedTextBrush}" Margin="0,0,0,6"/>
                                    <controls:MetricChart x:Name="KgrSrChart" Height="120"/>
                                </DockPanel>
                            </Border>

                            <Border CornerRadius="8"
                                    BorderThickness="1"
                                    BorderBrush="#E5E7EB"
                                    Background="#F9FAFB"
                                    Padding="8"
                                    Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBlock DockPanel.Dock="Top" Text="SC" FontSize="12" Foreground="{StaticResource MutedTextBrush}" Margin="0,0,0,6"/>
                                    <controls:MetricChart x:Name="KgrScChart" Height="120"/>
                                </DockPanel>
                            </Border>

                            <Border CornerRadius="8"
                                    BorderThickness="1"
                                    BorderBrush="#E5E7EB"
                                    Background="#F9FAFB"
                                    Padding="8"
                                    Margin="0,0,0,10">
                                <DockPanel LastChildFill="True">
                                    <TextBlock DockPanel.Dock="Top" Text="HR" FontSize="12" Foreground="{StaticResource MutedTextBrush}" Margin="0,0,0,6"/>
                                    <controls:MetricChart x:Name="KgrHrChart" Height="120"/>
                                </DockPanel>
                            </Border>

                            <Border CornerRadius="8"
                                    BorderThickness="1"
                                    BorderBrush="#E5E7EB"
                                    Background="#F9FAFB"
                                    Padding="8">
                                <DockPanel LastChildFill="True">
                                    <TextBlock DockPanel.Dock="Top" Text="PPG" FontSize="12" Foreground="{StaticResource MutedTextBrush}" Margin="0,0,0,6"/>
                                    <controls:MetricChart x:Name="KgrPpgChart" Height="120"/>
                                </DockPanel>
                            </Border>
                        </StackPanel>
                    </Border>

                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Border>
</Grid>
</Window>
