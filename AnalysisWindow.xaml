<Window x:Class="NeuroBureau.Experiment.AnalysisWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        xmlns:local="clr-namespace:NeuroBureau.Experiment"
        xmlns:controls="clr-namespace:NeuroBureau.Experiment.Controls"

        Title="Анализ"
        Width="1800" Height="840"
        WindowStartupLocation="CenterOwner"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        Closing="Window_Closing"
        Closed="Window_Closed">

    <Window.Resources>
        <!-- Цвета -->
        <SolidColorBrush x:Key="BgBrush" Color="#FFF7F7F9"/>
        <SolidColorBrush x:Key="CardBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="CardHoverBrush" Color="#FFFBFBFD"/>
        <SolidColorBrush x:Key="TextBrush" Color="#FF111827"/>
        <SolidColorBrush x:Key="MutedTextBrush" Color="#FF6B7280"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#2563EB"/>
        <SolidColorBrush x:Key="BorderBrushSoft" Color="#1A000000"/>

        <!-- Мини-стиль "пилюля" -->
        <Style x:Key="PillButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#FF111827"/>
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFF3F4F6"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFE5E7EB"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль вкладок как в главном окне ===== -->
        <Style x:Key="TopTabControlStyle" TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
        </Style>

        <Style x:Key="TopTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="18,12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Bd"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0,0,0,2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                TextElement.FontWeight="SemiBold"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль списка как карточки экспериментов ===== -->
        <Style x:Key="StimulusListItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,14"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Grid SnapsToDevicePixels="True">
                            <!-- ТОЛЬКО тень (без текста внутри) -->
                            <Border x:Name="Shadow"
                                    CornerRadius="16"
                                    Background="{StaticResource CardBrush}">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="22" ShadowDepth="2" Opacity="0.10"/>
                                </Border.Effect>
                            </Border>

                            <!-- Карточка с текстом БЕЗ эффектов -->
                            <Border x:Name="Bd"
                                    Background="{StaticResource CardBrush}"
                                    BorderBrush="#1A000000"
                                    BorderThickness="1"
                                    CornerRadius="16"
                                    Padding="18"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter/>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource CardHoverBrush}"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="26" ShadowDepth="2" Opacity="0.14"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#FF93C5FD"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="28" ShadowDepth="2" Opacity="0.18"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="18">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="500"/>
            <ColumnDefinition Width="14"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition x:Name="KgrSpacerColumn" Width="14"/>
            <ColumnDefinition x:Name="KgrColumn" Width="360"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- LEFT PANEL: stimuli + results -->
        <Grid Grid.Column="0" Grid.RowSpan="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" MinHeight="200"/>
                <RowDefinition Height="14"/>
                <RowDefinition Height="Auto" MinHeight="150"/>
            </Grid.RowDefinitions>

            <!-- Stimuli list -->
            <Border Grid.Row="0"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14">
                <DockPanel LastChildFill="True">
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <TextBlock Text="Стимулы" FontSize="16" FontWeight="SemiBold"/>
                        <TextBlock x:Name="ResultInfoText"
                                   Margin="0,4,0,0"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <ListBox x:Name="StimuliList"
                         SelectionChanged="StimuliList_SelectionChanged"
                         BorderThickness="0"
                         Background="Transparent"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         ItemContainerStyle="{StaticResource StimulusListItemStyle}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel>
                                <!-- Миниатюра -->
                                <Grid Height="140" Margin="0,0,0,10">
                                    <Border CornerRadius="10"
                                            BorderBrush="{StaticResource BorderBrushSoft}"
                                            BorderThickness="1"
                                            Background="{Binding PreviewBackground}"/>

                                    <Border x:Name="ThumbClip" CornerRadius="10" ClipToBounds="True">
                                        <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                                    </Border>

                                    <TextBlock x:Name="VideoIcon"
                                               Text="▶"
                                               FontSize="36"
                                               Foreground="{StaticResource MutedTextBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Visibility="Collapsed"/>

                                    <TextBlock x:Name="MissingIcon"
                                               Text="□"
                                               FontSize="28"
                                               Foreground="{StaticResource MutedTextBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Visibility="Collapsed"/>
                                </Grid>

                                <!-- Название и описание -->
                                <TextBlock Text="{Binding Title}"
                                           FontWeight="SemiBold"
                                           FontSize="14"
                                           TextWrapping="Wrap"
                                           TextTrimming="CharacterEllipsis"
                                           MaxHeight="40"/>
                                <TextBlock Text="{Binding Subtitle}"
                                           Margin="0,4,0,0"
                                           Foreground="{StaticResource MutedTextBrush}"
                                           FontSize="12"
                                           TextWrapping="Wrap"/>
                            </StackPanel>

                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding Thumbnail}" Value="{x:Null}">
                                    <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding IsVideo}" Value="True">
                                    <Setter TargetName="VideoIcon" Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding HasFile}" Value="False">
                                    <Setter TargetName="MissingIcon" Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

            <!-- Results DataGrid -->
            <Border Grid.Row="2"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14"
                    MaxHeight="300">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Результаты"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Margin="0,0,0,10"/>

                    <DataGrid x:Name="ResultsDataGrid"
                              PreviewMouseLeftButtonDown="ResultsDataGrid_PreviewMouseLeftButtonDown"
                              AutoGenerateColumns="False"
                              BorderThickness="0"
                              Background="Transparent"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              SelectionUnit="FullRow"
                              SelectionMode="Extended"
                              EnableRowVirtualization="True"
                              FontSize="12">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Width="32">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Center"
                                                Focusable="False" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Цвет" Width="140">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <Border Width="16" Height="16"
                                                    CornerRadius="3"
                                                    BorderThickness="1"
                                                    BorderBrush="LightGray"
                                                    Margin="0,0,6,0"
                                                    Background="{Binding ColorBrush}"
                                                    Cursor="Hand"
                                                    MouseLeftButtonDown="ResultColorSwatch_MouseLeftButtonDown"
                                                    Focusable="False" />
                                            <TextBlock Text="{Binding ColorHex}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Дата" Width="110" Binding="{Binding DateString}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Длит., с" Width="70" Binding="{Binding DurationSec}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Имя" Width="*" Binding="{Binding Name}" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>

        <!-- RIGHT: preview -->
        <Border Grid.Column="2" Grid.Row="0"
                CornerRadius="14"
                BorderThickness="0"
                BorderBrush="Transparent"
                Background="White"
                Padding="14">

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Grid для размещения вкладок и кнопки экспорта в одной строке -->
                <Grid Grid.Row="0" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TabControl x:Name="VisualizationModeTabs"
                                Grid.Column="0"
                                Style="{StaticResource TopTabControlStyle}"
                                SelectionChanged="VisualizationModeTabs_SelectionChanged">
                        <TabItem Header="Движение взгляда" Style="{StaticResource TopTabItemStyle}"/>
                        <TabItem Header="Тепловая карта" Style="{StaticResource TopTabItemStyle}"/>
                        <TabItem Header="Пчелиный рой" Style="{StaticResource TopTabItemStyle}"/>
                        <TabItem Header="Области интереса" Style="{StaticResource TopTabItemStyle}"/>
                    </TabControl>

                    <!-- Кнопка экспорта данных эксперимента -->
                    <Button x:Name="ExportBtn"
                            Grid.Column="2"
                            Style="{StaticResource PillButtonStyle}"
                            VerticalAlignment="Center"
                            Padding="16,8"
                            Click="ExportBtn_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#xE74E;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                            <TextBlock Text="Экспорт"/>
                        </StackPanel>
                    </Button>
                </Grid>

                <!-- AnalysisWindow.xaml -->
                <Border x:Name="AoiToolbar"
                        Grid.Row="1"
                        Background="#F3F4F6" BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="8" Padding="10" Margin="0,0,0,10"
                        Visibility="Collapsed"> 
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="Форма:" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <ComboBox x:Name="AoiShapeCombo" Width="120" Margin="0,0,16,0" SelectionChanged="AoiShapeCombo_SelectionChanged" Height="28">
                            <ComboBoxItem Content="Прямоугольник" Tag="Rectangle" IsSelected="True"/>
                            <ComboBoxItem Content="Эллипс" Tag="Ellipse"/>
                            <ComboBoxItem Content="Полигон" Tag="Polygon"/>
                        </ComboBox>

                        <!-- ПАЛИТРА: Кнопка вместо ComboBox -->
                        <TextBlock Text="Цвет:" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <Button x:Name="AoiColorBtn" 
                                Width="40" Height="28" 
                                Margin="0,0,16,0" 
                                BorderThickness="1" BorderBrush="#CCC"
                                Click="AoiColorBtn_Click" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border CornerRadius="4" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="1"/>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>

                        <TextBlock Text="Толщина:" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <ComboBox x:Name="AoiThickCombo" Width="60" Margin="0,0,16,0" SelectionChanged="AoiStyle_Changed" Height="28">
                            <ComboBoxItem Content="1 пкс" Tag="1.0"/>
                            <ComboBoxItem Content="2 пкс" Tag="2.0" IsSelected="True"/>
                            <ComboBoxItem Content="3 пкс" Tag="3.0"/>
                            <ComboBoxItem Content="4 пкс" Tag="4.0"/>
                            <ComboBoxItem Content="5 пкс" Tag="5.0"/>
                        </ComboBox>
                    </StackPanel>
                </Border>
                
                <!-- стимул + оверлеи -->
                <Viewbox Grid.Row="2" Stretch="Uniform">
                    <Canvas x:Name="ScreenCanvas"
                            Background="Black"
                            ClipToBounds="True">

                        <!-- color stimulus -->
                        <Border x:Name="ColorPreview"
                                CornerRadius="12"
                                Background="Transparent"
                                Visibility="Collapsed"/>

                        <!-- image stimulus -->
                        <Image x:Name="PreviewImage"
                            Visibility="Collapsed"
                            Stretch="Fill"/>

                        <!-- video stimulus -->
                        <vlc:VideoView x:Name="PreviewVlc"
                                    Visibility="Collapsed">
                            <Grid>
                                <local:FixationOverlay x:Name="VideoFixOverlay"
                                                    Visibility="Collapsed"
                                                    IsHitTestVisible="False"
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Stretch"/>
                                <local:HeatmapOverlay x:Name="VideoHeatmapOverlay"
                                                      Visibility="Collapsed"
                                                      IsHitTestVisible="False"
                                                      HorizontalAlignment="Stretch"
                                                      VerticalAlignment="Stretch"/>

                                <!-- НОВЫЙ ОВЕРЛЕЙ ДЛЯ ВИДЕО -->
                                <local:BeeSwarmOverlay x:Name="VideoBeeOverlay"
                                                       Visibility="Collapsed"
                                                       IsHitTestVisible="False"
                                                       HorizontalAlignment="Stretch"
                                                       VerticalAlignment="Stretch"/>
                            </Grid>
                        </vlc:VideoView>

                        <!-- overlay фиксаций (для картинок/цвета) -->
                        <local:FixationOverlay x:Name="FixOverlay"
                                            Visibility="Collapsed"
                                            IsHitTestVisible="False"/>

                        <!-- heatmap overlay (для картинок/цвета) -->
                        <local:HeatmapOverlay x:Name="HeatmapOverlay"
                                              Visibility="Collapsed"
                                              IsHitTestVisible="False"/>

                        <!-- НОВЫЙ ОВЕРЛЕЙ ДЛЯ КАРТИНОК -->
                        <local:BeeSwarmOverlay x:Name="BeeOverlay"
                                               Visibility="Collapsed"
                                               IsHitTestVisible="False"/>
                        <!-- IsHitTestVisible="True" чтобы мы могли рисовать мышкой -->
                        <!-- Background убран, рисуется программно -->
                        <local:AoiOverlay x:Name="AoiOverlay"
                                        Visibility="Collapsed"
                                        IsHitTestVisible="True"
                                        Width="{Binding ActualWidth, ElementName=ScreenCanvas}"
                                        Height="{Binding ActualHeight, ElementName=ScreenCanvas}"
                                        MouseLeftButtonDown="AoiOverlay_MouseDown"
                                        MouseMove="AoiOverlay_MouseMove"
                                        MouseLeftButtonUp="AoiOverlay_MouseUp"/>

                        <TextBlock x:Name="EmptyHint" Text="Выбери стимул слева" Foreground="#88000000" FontSize="16" TextAlignment="Center"/>
                    </Canvas>
                </Viewbox>

                <!-- НИЖНЯЯ ОБЛАСТЬ (ГРАФИК ИЛИ ТАБЛИЦА) -->
                <Grid Grid.Row="3" Margin="0,12,0,0" Height="150">

                    <!-- 1. График (виден в обычных режимах) -->
                    <controls:MetricChart x:Name="MetricChart"/>

                    <!-- 2. Таблица AOI (видна только в режиме AOI) -->
                    <DataGrid x:Name="AoiResultsGrid" 
                            Visibility="Collapsed"
                            AutoGenerateColumns="False" 
                            CanUserAddRows="False"
                            HeadersVisibility="Column"
                            GridLinesVisibility="Horizontal"
                            Background="White"
                            BorderThickness="1" BorderBrush="#E5E7EB"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto">
                        <DataGrid.Columns>
                            <!-- 1. Цвет -->
                            <DataGridTemplateColumn Header="Цвет" Width="40">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Width="16" Height="16" CornerRadius="8" Background="{Binding ColorHex}" HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- 2. Название -->
                            <DataGridTextColumn Header="Название" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="120"/>

                            <!-- 3. Основные метрики -->
                            <DataGridTextColumn Header="Фиксаций (N)" Binding="{Binding FixationCount}" IsReadOnly="True" Width="90"/>
                            <DataGridTextColumn Header="Общее время (с)" Binding="{Binding TotalDwellTime, StringFormat=F2}" IsReadOnly="True" Width="110"/>
                            
                            <!-- 4. Новые метрики по вашему списку -->
                            <DataGridTextColumn Header="До первой (N)" Binding="{Binding FixationsBeforeFirst}" IsReadOnly="True" Width="90" ToolTipService.ToolTip="Количество фиксаций до первой фиксации в области интереса"/>
                            <DataGridTextColumn Header="До первой фиксации (с)" Binding="{Binding TimeToFirstFixation, StringFormat=F2}" IsReadOnly="True" Width="130" ToolTipService.ToolTip="Время до первой фиксации"/>
                            <DataGridTextColumn Header="Длит. первой (с)" Binding="{Binding FirstFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="110"/>
                            
                            <DataGridTextColumn Header="Возвраты (N)" Binding="{Binding RevisitCount}" IsReadOnly="True" Width="90"/>
                            <DataGridTextColumn Header="Ср. длит. фикс. (с)" Binding="{Binding AvgFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="120"/>
                            
                            <DataGridTextColumn Header="Саккад (N)" Binding="{Binding SaccadeCount}" IsReadOnly="True" Width="80"/>
                            <DataGridTextColumn Header="Ср. ампл. саккад (пкс)" Binding="{Binding AvgSaccadeAmplitude, StringFormat=F1}" IsReadOnly="True" Width="130"/>
                            
                            <DataGridTextColumn Header="Путь (пкс)" Binding="{Binding ScanpathLength, StringFormat=F0}" IsReadOnly="True" Width="80"/>
                            <DataGridTextColumn Header="Площадь (%)" Binding="{Binding AreaRatio, StringFormat=F1}" IsReadOnly="True" Width="90"/>

                            <!-- Кнопка удаления -->
                            <DataGridTemplateColumn Width="40">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="✕" Click="DeleteAoiRow_Click" 
                                                Background="Transparent" BorderThickness="0" Foreground="Red" Cursor="Hand" ToolTip="Удалить область интереса"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Border>

        <!-- RIGHT BOTTOM: timeline -->
        <Border Grid.Column="2" Grid.Row="1"
                CornerRadius="14"
                BorderThickness="0"
                BorderBrush="Transparent"
                Background="White"
                Padding="12"
                Margin="0,14,0,0">
            <!-- Делаем место справа под кнопку настроек (как ты просила) -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- таймлайн (сужается, потому что справа отдельная колонка) -->
                <Grid Grid.Column="0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- video timeline (только для видео-стимула) -->
                    <Grid x:Name="VideoTimelinePanel" Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Button x:Name="PlayPauseBtn"
                                Grid.Column="0"
                                Width="110"
                                Padding="12,8"
                                Click="PlayPauseBtn_Click"
                                IsEnabled="False">
                            ▶ Воспроизвести
                        </Button>

                        <Slider x:Name="TimeSlider"
                                Grid.Column="2"
                                Minimum="0"
                                Maximum="1"
                                Value="0"
                                IsEnabled="False"
                                PreviewMouseDown="TimeSlider_PreviewMouseDown"
                                PreviewMouseUp="TimeSlider_PreviewMouseUp"/>

                        <TextBlock x:Name="TimeText"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="00:00 / 00:00"/>
                    </Grid>

                    <!-- time slice (для картинок/цвета) -->
                    <Grid x:Name="SliceTimelinePanel"
                          Grid.Row="1"
                          Margin="0,10,0,0"
                          Visibility="Collapsed">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <Button x:Name="SlicePlayPauseBtn"
                                    Style="{StaticResource PillButtonStyle}"
                                    Width="40"
                                    Padding="0"
                                    Click="SlicePlayPauseBtn_Click"
                                    IsEnabled="False">
                                <TextBlock x:Name="SlicePlayPauseIcon"
                                           Text="▶"
                                           FontSize="14"/>
                            </Button>
                            <Button x:Name="SliceStopBtn"
                                    Style="{StaticResource PillButtonStyle}"
                                    Width="40"
                                    Padding="0"
                                    Margin="6,0,0,0"
                                    Click="SliceStopBtn_Click"
                                    IsEnabled="False">
                                <TextBlock Text="■" FontSize="12"/>
                            </Button>
                        </StackPanel>

                        <Grid Grid.Column="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="От"/>
                                <controls:TimeRangeSlider x:Name="SliceRange"
                                                         Grid.Column="2"
                                                         Minimum="0"
                                                         Maximum="1"
                                                         StartValue="0"
                                                         EndValue="1"
                                                         RangeChanged="SliceRange_RangeChanged"/>
                            </Grid>

                            <Grid Grid.Row="1" Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="Время"/>
                                <Slider x:Name="SliceTimeSlider"
                                        Grid.Column="2"
                                        Minimum="0"
                                        Maximum="1"
                                        Value="0"
                                        IsEnabled="False"
                                        ValueChanged="SliceTimeSlider_ValueChanged"/>
                            </Grid>
                        </Grid>

                        <TextBlock x:Name="SliceText"
                                   Grid.Row="0"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="—"/>

                        <TextBlock x:Name="SliceTimeText"
                                   Grid.Row="1"
                                   Grid.Column="4"
                                   VerticalAlignment="Center"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   Text="—"/>
                    </Grid>

                </Grid>

                <!-- кнопка настроек анализа -->
                <Button x:Name="AnalysisSettingsBtn"
                        Grid.Column="2"
                        Style="{StaticResource PillButtonStyle}"
                        Width="160"
                        Padding="14,0"
                        Click="AnalysisSettingsBtn_Click"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                        <TextBlock Text="Настройки"/>
                    </StackPanel>
                </Button>

                <!-- ПРАВЫЕ КНОПКИ -->
                <Grid Grid.Column="4" VerticalAlignment="Center">
                    <!-- кнопка настроек отображения -->
                    <Button x:Name="VisualizationSettingsBtn"
                            Style="{StaticResource PillButtonStyle}"
                            Width="140"
                            Padding="14,0"
                            Click="VisualizationSettingsBtn_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#xE790;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                            <TextBlock Text="Отображение"/>
                        </StackPanel>
                    </Button>
                    <!-- Новая кнопка экспорта (видна только в режиме AOI) -->
                    <Button x:Name="ExportAoiBtn"
                            Style="{StaticResource PillButtonStyle}"
                            Width="140"
                            Padding="14,0"
                            Click="ExportAoiCsv_Click"
                            Visibility="Collapsed">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#xE74E;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                            <TextBlock Text="Экспорт CSV"/>
                        </StackPanel>
                    </Button>
                </Grid>
                
            </Grid> <!-- Закрываем внутренний Grid -->
        </Border> <!-- Закрываем Border -->

                <!-- RIGHT: KGR charts -->
        <Border x:Name="KgrChartsPanel"
                Grid.Column="4"
                Grid.RowSpan="2"
                CornerRadius="14"
                BorderThickness="0"
                BorderBrush="Transparent"
                Background="White"
                Padding="14"
                Visibility="Collapsed">
            <!-- ВАЖНО: StackPanel не "растягивает" контент по высоте,
                 из-за этого Grid со '*' строками может получить почти нулевую высоту.
                 Делаем Grid с Auto+* чтобы графики гарантированно получили место. -->
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
                           Text="Сигналы КГР по стимулу"
                           FontSize="16"
                           FontWeight="SemiBold"
                           Margin="0,0,0,10"/>

                <Grid Grid.Row="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <controls:MetricChart x:Name="KgrSrChart" Grid.Row="0" Margin="0,0,0,10"/>
                    <controls:MetricChart x:Name="KgrScChart" Grid.Row="1" Margin="0,0,0,10"/>
                    <controls:MetricChart x:Name="KgrHrChart" Grid.Row="2" Margin="0,0,0,10"/>
                    <controls:MetricChart x:Name="KgrPpgChart" Grid.Row="3"/>
                </Grid>

            </Grid>
        </Border>


    </Grid>
</Window>
