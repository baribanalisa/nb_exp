<Window x:Class="NeuroBureau.Experiment.AnalysisWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vlc="clr-namespace:LibVLCSharp.WPF;assembly=LibVLCSharp.WPF"
        xmlns:local="clr-namespace:NeuroBureau.Experiment"
        xmlns:controls="clr-namespace:NeuroBureau.Experiment.Controls"

        Title="Анализ"
        Width="1800" Height="840"
        WindowStartupLocation="CenterOwner"
        FontFamily="Segoe UI"
        Loaded="Window_Loaded"
        PreviewKeyDown="AnalysisWindow_PreviewKeyDown"
        Closing="Window_Closing"
        Closed="Window_Closed">

    <Window.Resources>
        <!-- Цвета -->
        <SolidColorBrush x:Key="BgBrush" Color="#FFF7F7F9"/>
        <SolidColorBrush x:Key="CardBrush" Color="#FFFFFFFF"/>
        <SolidColorBrush x:Key="CardHoverBrush" Color="#FFFBFBFD"/>
        <SolidColorBrush x:Key="TextBrush" Color="#FF111827"/>
        <SolidColorBrush x:Key="MutedTextBrush" Color="#FF6B7280"/>
        <SolidColorBrush x:Key="BlueBrush" Color="#2563EB"/>
        <SolidColorBrush x:Key="BorderBrushSoft" Color="#1A000000"/>

        <!-- Мини-стиль "пилюля" -->
        <Style x:Key="PillButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="42"/>
            <Setter Property="Padding" Value="16,0"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#FF111827"/>
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="10"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFF3F4F6"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#FFE5E7EB"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль вкладок как в главном окне ===== -->
        <Style x:Key="TopTabControlStyle" TargetType="TabControl">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="0"/>
        </Style>

        <Style x:Key="TopTabItemStyle" TargetType="TabItem">
            <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Padding" Value="18,12"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Bd"
                                Background="Transparent"
                                BorderBrush="Transparent"
                                BorderThickness="0,0,0,2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header"
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                TextElement.FontWeight="SemiBold"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BlueBrush}"/>
                                <Setter Property="Foreground" Value="{StaticResource BlueBrush}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="{StaticResource TextBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль кнопки тулбара визуализаций ===== -->
        <Style x:Key="ToolbarRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="#6B7280"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                CornerRadius="6"
                                Width="{TemplateBinding Width}"
                                Height="{TemplateBinding Height}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#E5E7EB"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#2563EB"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- ===== Стиль списка как карточки экспериментов ===== -->
        <Style x:Key="StimulusListItemStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,14"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Grid SnapsToDevicePixels="True">
                            <!-- ТОЛЬКО тень (без текста внутри) -->
                            <Border x:Name="Shadow"
                                    CornerRadius="16"
                                    Background="{StaticResource CardBrush}">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="22" ShadowDepth="2" Opacity="0.10"/>
                                </Border.Effect>
                            </Border>

                            <!-- Карточка с текстом БЕЗ эффектов -->
                            <Border x:Name="Bd"
                                    Background="{StaticResource CardBrush}"
                                    BorderBrush="#1A000000"
                                    BorderThickness="1"
                                    CornerRadius="16"
                                    Padding="18"
                                    SnapsToDevicePixels="True">
                                <ContentPresenter/>
                            </Border>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource CardHoverBrush}"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="26" ShadowDepth="2" Opacity="0.14"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="#FF93C5FD"/>
                                <Setter TargetName="Shadow" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect BlurRadius="28" ShadowDepth="2" Opacity="0.18"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.55"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid Margin="18">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300"/>
            <ColumnDefinition Width="6"/>
            <ColumnDefinition Width="400" MinWidth="250"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- ROW 0: Название эксперимента -->
        <TextBlock x:Name="ExperimentNameText"
                   Grid.Column="0" Grid.Row="0"
                   FontSize="18"
                   FontWeight="SemiBold"
                   Foreground="#111827"
                   Margin="0,0,0,12"
                   Text="Эксперимент"/>

        <!-- CENTER: preview -->
        <Border Grid.Column="0" Grid.Row="1"
                CornerRadius="14"
                BorderThickness="0"
                BorderBrush="Transparent"
                Background="White"
                Padding="14">

            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- COLUMN 0: Вертикальная панель инструментов (как в Photoshop) -->
                <Border Grid.Column="0"
                        Background="#F3F4F6"
                        CornerRadius="8"
                        Padding="4"
                        Margin="0,0,12,0"
                        VerticalAlignment="Center">
                    <StackPanel Orientation="Vertical">
                        <!-- Кнопки настроек и экспорта -->
                        <Button x:Name="AnalysisSettingsBtn"
                                Width="40" Height="40"
                                Margin="2"
                                Background="Transparent"
                                BorderThickness="0"
                                Click="AnalysisSettingsBtn_Click"
                                Cursor="Hand"
                                ToolTip="Настройки анализа">
                            <TextBlock Text="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#6B7280"/>
                        </Button>
                        <Button x:Name="ExportMenuBtn"
                                Width="40" Height="40"
                                Margin="2"
                                Background="Transparent"
                                BorderThickness="0"
                                Click="ExportMenuBtn_Click"
                                Cursor="Hand"
                                ToolTip="Экспорт">
                            <Button.ContextMenu>
                                <ContextMenu x:Name="ExportContextMenu">
                                    <MenuItem Header="Экспорт визуализации" Click="ExportVisualization_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE8B9;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Экспорт областей интереса" Click="ExportAoiCsv_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE8A5;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Экспорт статистики" Click="ExportStatistics_Click">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE9D9;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem x:Name="ExportKgrMenuItem" Header="Экспорт данных КГР" Click="ExportKgr_Click" Visibility="Collapsed">
                                        <MenuItem.Icon>
                                            <TextBlock Text="&#xE95A;" FontFamily="Segoe MDL2 Assets" FontSize="14"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Button.ContextMenu>
                            <TextBlock Text="&#xE74E;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="#6B7280"/>
                        </Button>

                        <Separator Margin="4,8" Background="#E5E7EB"/>

                        <!-- Визуализации -->
                        <RadioButton x:Name="ToolEyeMovement"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     IsChecked="True"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Карта движения взгляда"
                                     Tag="0"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE7B3;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolHeatmap"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Тепловая карта"
                                     Tag="1"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE9D9;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolBeeSwarm"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Пчелиный рой"
                                     Tag="2"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xECAD;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>
                        <RadioButton x:Name="ToolAoi"
                                     GroupName="VisualizationTools"
                                     Width="40" Height="40"
                                     Margin="2"
                                     Checked="VisualizationTool_Checked"
                                     ToolTip="Области интереса"
                                     Tag="3"
                                     Style="{StaticResource ToolbarRadioButtonStyle}">
                            <TextBlock Text="&#xE7C5;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                        </RadioButton>

                        <Separator Margin="4,8" Background="#E5E7EB"/>

                        <!-- Инструменты AOI (видны только в режиме AOI) -->
                        <StackPanel x:Name="AoiToolsPanel" Visibility="Collapsed">
                            <RadioButton x:Name="AoiToolRect"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         IsChecked="True"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Прямоугольник"
                                         Tag="Rectangle"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xE739;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>
                            <RadioButton x:Name="AoiToolEllipse"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Эллипс"
                                         Tag="Ellipse"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xEA3A;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>
                            <RadioButton x:Name="AoiToolPolygon"
                                         GroupName="AoiShapeTools"
                                         Width="40" Height="40"
                                         Margin="2"
                                         Checked="AoiShapeTool_Checked"
                                         ToolTip="Полигон"
                                         Tag="Polygon"
                                         Style="{StaticResource ToolbarRadioButtonStyle}">
                                <TextBlock Text="&#xE7C8;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            </RadioButton>

                            <Separator Margin="4,8" Background="#E5E7EB"/>

                            <!-- Цвет AOI -->
                            <Button x:Name="AoiColorBtn"
                                    Width="36" Height="36"
                                    Margin="2"
                                    BorderThickness="2" BorderBrush="#CCC"
                                    Click="AoiColorBtn_Click"
                                    Cursor="Hand"
                                    ToolTip="Цвет области">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border CornerRadius="4" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="2"/>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- COLUMN 1: Основной контент -->
                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- ROW 0: Таймлайн сверху -->
                    <Grid Grid.Row="0" Margin="0,0,0,12">
                    <!-- Таймлайн -->
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- video timeline (для видео-стимула) -->
                        <Grid x:Name="VideoTimelinePanel" Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button x:Name="PlayPauseBtn"
                                    Grid.Column="0"
                                    Style="{StaticResource PillButtonStyle}"
                                    Width="80"
                                    Padding="14,0"
                                    Click="PlayPauseBtn_Click"
                                    IsEnabled="False">
                                ▶ Play
                            </Button>

                            <Slider x:Name="TimeSlider"
                                    Grid.Column="2"
                                    Minimum="0"
                                    Maximum="1"
                                    Value="0"
                                    IsEnabled="False"
                                    PreviewMouseDown="TimeSlider_PreviewMouseDown"
                                    PreviewMouseUp="TimeSlider_PreviewMouseUp"/>

                            <TextBlock x:Name="TimeText"
                                       Grid.Column="4"
                                       VerticalAlignment="Center"
                                       Foreground="#88000000"
                                       FontSize="12"
                                       Text="00:00 / 00:00"/>
                        </Grid>

                        <!-- time slice (для картинок/цвета) -->
                        <Grid x:Name="SliceTimelinePanel"
                              Grid.Row="1"
                              Margin="0,10,0,0"
                              Visibility="Collapsed">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                <Button x:Name="SlicePlayPauseBtn"
                                        Style="{StaticResource PillButtonStyle}"
                                        Width="40"
                                        Padding="0"
                                        Click="SlicePlayPauseBtn_Click"
                                        IsEnabled="False">
                                    <TextBlock x:Name="SlicePlayPauseIcon"
                                               Text="▶"
                                               FontSize="14"/>
                                </Button>
                                <Button x:Name="SliceStopBtn"
                                        Style="{StaticResource PillButtonStyle}"
                                        Width="40"
                                        Padding="0"
                                        Margin="6,0,0,0"
                                        Click="SliceStopBtn_Click"
                                        IsEnabled="False">
                                    <TextBlock Text="■" FontSize="12"/>
                                </Button>
                            </StackPanel>

                            <Grid Grid.Column="2">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="От"/>
                                    <controls:TimeRangeSlider x:Name="SliceRange"
                                                             Grid.Column="2"
                                                             Minimum="0"
                                                             Maximum="1"
                                                             StartValue="0"
                                                             EndValue="1"
                                                             RangeChanged="SliceRange_RangeChanged"/>
                                </Grid>

                                <Grid Grid.Row="1" Margin="0,8,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#88000000" FontSize="12" Text="Время"/>
                                    <Slider x:Name="SliceTimeSlider"
                                            Grid.Column="2"
                                            Minimum="0"
                                            Maximum="1"
                                            Value="0"
                                            IsEnabled="False"
                                            ValueChanged="SliceTimeSlider_ValueChanged"/>
                                </Grid>
                            </Grid>

                            <TextBlock x:Name="SliceText"
                                       Grid.Row="0"
                                       Grid.Column="4"
                                       VerticalAlignment="Center"
                                       Foreground="#88000000"
                                       FontSize="12"
                                       Text="—"/>

                            <TextBlock x:Name="SliceTimeText"
                                       Grid.Row="1"
                                       Grid.Column="4"
                                       VerticalAlignment="Center"
                                       Foreground="#88000000"
                                       FontSize="12"
                                       Text="—"/>
                        </Grid>

                        <!-- ROW 2: Графики КГР (горизонтально, только под таймлайном) -->
                        <Border x:Name="KgrChartsPanel"
                                Grid.Row="2"
                                Background="#F9FAFB"
                                CornerRadius="8"
                                Padding="8"
                                Margin="0,8,0,0"
                                Visibility="Collapsed"
                                Width="{Binding ActualWidth, ElementName=StimulusViewbox}"
                                HorizontalAlignment="Center">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <controls:MetricChart x:Name="KgrSrChart" Grid.Column="0" Height="80"/>
                                <controls:MetricChart x:Name="KgrScChart" Grid.Column="2" Height="80"/>
                                <controls:MetricChart x:Name="KgrHrChart" Grid.Column="4" Height="80"/>
                                <controls:MetricChart x:Name="KgrPpgChart" Grid.Column="6" Height="80"/>
                            </Grid>
                        </Border>
                    </Grid>
                    </Grid>

                    <!-- ROW 1: Стимул + оверлеи -->
                    <Viewbox x:Name="StimulusViewbox" Grid.Row="1" Stretch="Uniform" HorizontalAlignment="Center">
                    <Canvas x:Name="ScreenCanvas"
                            Background="Black"
                            ClipToBounds="True">

                        <!-- color stimulus -->
                        <Border x:Name="ColorPreview"
                                CornerRadius="12"
                                Background="Transparent"
                                Visibility="Collapsed"/>

                        <!-- image stimulus -->
                        <Image x:Name="PreviewImage"
                            Visibility="Collapsed"
                            Stretch="Fill"/>

                        <!-- video stimulus -->
                        <vlc:VideoView x:Name="PreviewVlc"
                                    Visibility="Collapsed">
                            <Grid>
                                <local:FixationOverlay x:Name="VideoFixOverlay"
                                                    Visibility="Collapsed"
                                                    IsHitTestVisible="False"
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Stretch"/>
                                <local:HeatmapOverlay x:Name="VideoHeatmapOverlay"
                                                      Visibility="Collapsed"
                                                      IsHitTestVisible="False"
                                                      HorizontalAlignment="Stretch"
                                                      VerticalAlignment="Stretch"/>

                                <!-- НОВЫЙ ОВЕРЛЕЙ ДЛЯ ВИДЕО -->
                                <local:BeeSwarmOverlay x:Name="VideoBeeOverlay"
                                                       Visibility="Collapsed"
                                                       IsHitTestVisible="False"
                                                       HorizontalAlignment="Stretch"
                                                       VerticalAlignment="Stretch"/>
                            </Grid>
                        </vlc:VideoView>

                        <!-- overlay фиксаций (для картинок/цвета) -->
                        <local:FixationOverlay x:Name="FixOverlay"
                                            Visibility="Collapsed"
                                            IsHitTestVisible="False"/>

                        <!-- heatmap overlay (для картинок/цвета) -->
                        <local:HeatmapOverlay x:Name="HeatmapOverlay"
                                              Visibility="Collapsed"
                                              IsHitTestVisible="False"/>

                        <!-- НОВЫЙ ОВЕРЛЕЙ ДЛЯ КАРТИНОК -->
                        <local:BeeSwarmOverlay x:Name="BeeOverlay"
                                               Visibility="Collapsed"
                                               IsHitTestVisible="False"/>
                        <!-- IsHitTestVisible="True" чтобы мы могли рисовать мышкой -->
                        <!-- Background убран, рисуется программно -->
                        <local:AoiOverlay x:Name="AoiOverlay"
                                        Visibility="Collapsed"
                                        IsHitTestVisible="True"
                                        Width="{Binding ActualWidth, ElementName=ScreenCanvas}"
                                        Height="{Binding ActualHeight, ElementName=ScreenCanvas}"
                                        MouseLeftButtonDown="AoiOverlay_MouseDown"
                                        MouseMove="AoiOverlay_MouseMove"
                                        MouseLeftButtonUp="AoiOverlay_MouseUp"/>

                        <TextBlock x:Name="EmptyHint" Text="Выбери стимул справа" Foreground="#88000000" FontSize="16" TextAlignment="Center"/>
                    </Canvas>
                    </Viewbox>

                    <!-- ROW 2: НИЖНЯЯ ОБЛАСТЬ (ГРАФИК ИЛИ ТАБЛИЦА) -->
                <Grid Grid.Row="2" Margin="0,12,0,0" Height="150"
                      Width="{Binding ActualWidth, ElementName=StimulusViewbox}"
                      HorizontalAlignment="Center">

                    <!-- 1. График (виден в обычных режимах) -->
                    <controls:MetricChart x:Name="MetricChart"/>

                    <!-- 2. Таблица AOI (видна только в режиме AOI) -->
                    <DataGrid x:Name="AoiResultsGrid"
                            Visibility="Collapsed"
                            AutoGenerateColumns="False"
                            CanUserAddRows="False"
                            HeadersVisibility="Column"
                            GridLinesVisibility="Horizontal"
                            Background="White"
                            BorderThickness="1" BorderBrush="#E5E7EB"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            PreviewKeyDown="AoiResultsGrid_PreviewKeyDown">
                        <DataGrid.Columns>
                            <!-- 1. Цвет -->
                            <DataGridTemplateColumn Header="Цвет" Width="40">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Width="16" Height="16" CornerRadius="8" Background="{Binding ColorHex}" HorizontalAlignment="Center"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <!-- 2. Название -->
                            <DataGridTextColumn Header="Название" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="120"/>

                            <!-- 3. Основные метрики -->
                            <DataGridTextColumn Header="Фиксаций (N)" Binding="{Binding FixationCount}" IsReadOnly="True" Width="90"/>
                            <DataGridTextColumn Header="Общее время (с)" Binding="{Binding TotalDwellTime, StringFormat=F2}" IsReadOnly="True" Width="110"/>

                            <!-- 4. Новые метрики по вашему списку -->
                            <DataGridTextColumn Header="До первой (N)" Binding="{Binding FixationsBeforeFirst}" IsReadOnly="True" Width="90" ToolTipService.ToolTip="Количество фиксаций до первой фиксации в области интереса"/>
                            <DataGridTextColumn Header="До первой фиксации (с)" Binding="{Binding TimeToFirstFixation, StringFormat=F2}" IsReadOnly="True" Width="130" ToolTipService.ToolTip="Время до первой фиксации"/>
                            <DataGridTextColumn Header="Длит. первой (с)" Binding="{Binding FirstFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="110"/>

                            <DataGridTextColumn Header="Возвраты (N)" Binding="{Binding RevisitCount}" IsReadOnly="True" Width="90"/>
                            <DataGridTextColumn Header="Ср. длит. фикс. (с)" Binding="{Binding AvgFixationDuration, StringFormat=F3}" IsReadOnly="True" Width="120"/>

                            <DataGridTextColumn Header="Саккад (N)" Binding="{Binding SaccadeCount}" IsReadOnly="True" Width="80"/>
                            <DataGridTextColumn Header="Ср. ампл. саккад (°)" Binding="{Binding AvgSaccadeAmplitudeDeg, StringFormat=F2}" IsReadOnly="True" Width="130"/>

                            <DataGridTextColumn Header="Путь (°)" Binding="{Binding ScanpathLengthDeg, StringFormat=F2}" IsReadOnly="True" Width="80"/>
                            <DataGridTextColumn Header="Площадь (%)" Binding="{Binding AreaRatio, StringFormat=F1}" IsReadOnly="True" Width="90"/>

                            <!-- Кнопка удаления -->
                            <DataGridTemplateColumn Width="40">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="✕" Click="DeleteAoiRow_Click"
                                                Background="Transparent" BorderThickness="0" Foreground="Red" Cursor="Hand" ToolTip="Удалить область интереса"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
                </Grid> <!-- Close Column 1 Grid -->
            </Grid> <!-- Close main outer Grid -->
        </Border>

        <!-- GridSplitter между центральной и правой панелями -->
        <GridSplitter Grid.Column="1" Grid.Row="1" Grid.RowSpan="2"
                      Width="6"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      Background="Transparent"
                      Cursor="SizeWE"/>

        <!-- RIGHT PANEL: stimuli + results -->
        <Grid Grid.Column="2" Grid.Row="0" Grid.RowSpan="3">
            <Grid.RowDefinitions>
                <RowDefinition Height="2*" MinHeight="150"/>
                <RowDefinition Height="6"/>
                <RowDefinition Height="*" MinHeight="120"/>
            </Grid.RowDefinitions>

            <!-- Stimuli list -->
            <Border Grid.Row="0"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14">
                <DockPanel LastChildFill="True">
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10">
                        <TextBlock Text="Стимулы" FontSize="16" FontWeight="SemiBold"/>
                        <TextBlock x:Name="ResultInfoText"
                                   Visibility="Collapsed"
                                   Margin="0,4,0,0"
                                   Foreground="#88000000"
                                   FontSize="12"
                                   TextWrapping="Wrap"/>
                    </StackPanel>

                    <ListBox x:Name="StimuliList"
                         SelectionChanged="StimuliList_SelectionChanged"
                         BorderThickness="0"
                         Background="Transparent"
                         ScrollViewer.CanContentScroll="True"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         VirtualizingStackPanel.ScrollUnit="Item"
                         ItemContainerStyle="{StaticResource StimulusListItemStyle}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel>
                                <!-- Миниатюра -->
                                <Grid Height="140" Margin="0,0,0,10">
                                    <Border CornerRadius="10"
                                            BorderBrush="{StaticResource BorderBrushSoft}"
                                            BorderThickness="1"
                                            Background="{Binding PreviewBackground}"/>

                                    <Border x:Name="ThumbClip" CornerRadius="10" ClipToBounds="True">
                                        <Image Source="{Binding Thumbnail}" Stretch="UniformToFill"/>
                                    </Border>

                                    <TextBlock x:Name="VideoIcon"
                                               Text="▶"
                                               FontSize="36"
                                               Foreground="{StaticResource MutedTextBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Visibility="Collapsed"/>

                                    <TextBlock x:Name="MissingIcon"
                                               Text="□"
                                               FontSize="28"
                                               Foreground="{StaticResource MutedTextBrush}"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Visibility="Collapsed"/>
                                </Grid>

                                <!-- Название и описание -->
                                <TextBlock Text="{Binding Title}"
                                           FontWeight="SemiBold"
                                           FontSize="14"
                                           TextWrapping="Wrap"
                                           TextTrimming="CharacterEllipsis"
                                           MaxHeight="40"/>
                                <TextBlock Text="{Binding Subtitle}"
                                           Margin="0,4,0,0"
                                           Foreground="{StaticResource MutedTextBrush}"
                                           FontSize="12"
                                           TextWrapping="Wrap"/>
                            </StackPanel>

                            <DataTemplate.Triggers>
                                <DataTrigger Binding="{Binding Thumbnail}" Value="{x:Null}">
                                    <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding IsVideo}" Value="True">
                                    <Setter TargetName="VideoIcon" Property="Visibility" Value="Visible"/>
                                    <Setter TargetName="ThumbClip" Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>

                                <DataTrigger Binding="{Binding HasFile}" Value="False">
                                    <Setter TargetName="MissingIcon" Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </DataTemplate.Triggers>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

            <!-- GridSplitter для регулировки высоты -->
            <GridSplitter Grid.Row="1"
                          Height="6"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Center"
                          Background="Transparent"
                          Cursor="SizeNS"
                          ResizeBehavior="PreviousAndNext"/>

            <!-- Results DataGrid -->
            <Border Grid.Row="2"
                    CornerRadius="14"
                    BorderThickness="0"
                    BorderBrush="Transparent"
                    Background="White"
                    Padding="14">
                <DockPanel LastChildFill="True">
                    <TextBlock DockPanel.Dock="Top"
                               Text="Результаты"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Margin="0,0,0,10"/>

                    <DataGrid x:Name="ResultsDataGrid"
                              PreviewMouseLeftButtonDown="ResultsDataGrid_PreviewMouseLeftButtonDown"
                              AutoGenerateColumns="False"
                              BorderThickness="0"
                              Background="Transparent"
                              GridLinesVisibility="None"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserResizeRows="False"
                              SelectionUnit="FullRow"
                              SelectionMode="Extended"
                              EnableRowVirtualization="True"
                              FontSize="12">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Width="32">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsVisible, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Center"
                                                Focusable="False" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Цвет" Width="50">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Width="20" Height="20"
                                                CornerRadius="4"
                                                BorderThickness="1"
                                                BorderBrush="LightGray"
                                                Background="{Binding ColorBrush}"
                                                Cursor="Hand"
                                                MouseLeftButtonDown="ResultColorSwatch_MouseLeftButtonDown"
                                                Focusable="False"
                                                HorizontalAlignment="Center"
                                                ToolTip="{Binding ColorHex}" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Дата" Width="110" Binding="{Binding DateString}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Длит., с" Width="70" Binding="{Binding DurationSec}" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Имя" Width="*" Binding="{Binding Name}" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>

    </Grid>
</Window>
